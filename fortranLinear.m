clear all;
setenv('TZ', 'America/New_York');
fclose('all');
set(groot,'defaultAxesTickLabelInterpreter','latex');
set(groot,'defaulttextinterpreter','latex');
set(groot,'defaultLegendInterpreter','latex');
set(groot,'defaultAxesFontSize',50); %found using get(groot,'factory')
set(groot,'defaultAxesLineWidth',10);
set(groot,'defaultLineLineWidth',10);
set(groot,'defaultLineMarkerSize',100);
set(groot,'defaultErrorbarLineWidth',10);
set(groot,'defaultErrorbarMarkerSize',100);
set(groot,'defaultAxesView',[0,90]);
set(groot,'defaultAxesBox','on');
set(groot,'defaultTextFontSize',50);
main = string(datetime('now','Format','M-d-y@HH.mm.ss'))+"fortranLinear";
mkdir(main);
tstart = tic;

cktocm = 0.69503364;
rmin = 3.771;
ekelvin = 141.574396948;
A = 333634.4 * ekelvin;
alp = 11.493139 / rmin;
bet = -1.082649 / rmin^2;
C6 = 1.1261753 * rmin^6;
C8 = 0.34453349 * rmin^8;
C10 = 0.72590255 * rmin^10;
D = 1.1422763 * rmin;
F = 1.0;

nr = 61; nt = 10;
tori = 0:10:90;
rori = 2.0:0.1:8.0;
coef = [...
 710069571.690928d0,       -1221412715.75570d0,        329456362.688392d0,...
 403355289.362671d0,       -292789332.565156d0,        35547737.5690381d0,...
 7923719.95478328d0,       -11211457.6252328d0,        30450141.2646486d0,...
 134565.830192267d0,        2403347.18333092d0,        2610391.20588634d0,...
 1457977.57342306d0,        364595.069416850d0,       -315634.452565748d0,...
-472567.484796604d0,       -389534.291902812d0,       -219884.442288155d0,...
-20038.7336019536d0,        99912.4507992574d0,        191278.609469249d0,...
 229487.077958744d0,        279325.676334220d0,        236877.933346126d0,...
 314578.249207014d0,        230965.508211387d0,        241494.267307208d0,...
 202898.604285589d0,        200957.126187948d0,        150025.766594365d0,...
 131664.397724437d0,        123861.528531350d0,        79925.0318179929d0,...
 96738.9326202578d0,        52085.4307965003d0,        58079.4240953802d0,...
 55442.4073346225d0,       -35264.7266007998d0,        168018.162177312d0,...
-90466.5515631800d0,       -148703.726055220d0,        422874.244609318d0,...
-332798.913695541d0,        88959.7054180738d0,        96488.9920245405d0,...
-154942.308784249d0,        176716.705542893d0,       -188861.834672830d0,...
 188026.686306799d0,       -181714.849700028d0,        182856.858161074d0,...
-136016.067041857d0,        44553.8670167625d0,        52689.0562168658d0,...
-438629.964442611d0,        2302160.93021393d0,       -9733654.12701035d0,...
 38476775.7411728d0,       -150991170.480774d0,        589771089.823242d0,...
-493319084.119064d0,        1322614487.49644d0,       -1976563274.47388d0,...
 1074309577.37349d0,       -470934309.808139d0,        33728990.7988920d0,...
-215219594.982523d0,       -40408831.6560262d0,        183577663.830231d0,...
 53957805.0957458d0,       -19580285.4256122d0,        30731282.1222498d0,...
 12073254.0124020d0,        4632036.90429898d0,       -3634954.56965293d0,...
-5427509.49182818d0,       -4924627.75056550d0,       -3198889.65603731d0,...
-1584665.96264506d0,        110678.888960040d0,        926185.704137092d0,...
 1682985.49864032d0,        2059223.28881805d0,        2131081.37520105d0,...
 2438001.22748715d0,        2113539.49819143d0,        2162648.05382262d0,...
 2107314.44530490d0,        1379342.66897145d0,        1908041.42215785d0,...
 1123826.36067962d0,        1179075.63185007d0,        900057.730469881d0,...
 856145.851611591d0,        611113.817323398d0,        598063.468709710d0,...
 389630.933924080d0,        444229.586256710d0,       -222487.615099832d0,...
 1409586.86154969d0,       -787650.271589734d0,       -1407709.19885700d0,...
 3878688.16614261d0,       -2928871.92244802d0,        674050.026510003d0,...
 808033.303779492d0,       -1278696.12031610d0,        1519554.10423803d0,...
-1542674.60491830d0,        1548317.95919167d0,       -1550427.98177387d0,...
 1510211.57276615d0,       -1485008.93064023d0,        1289131.15043758d0,...
-160839.444047630d0,       -4558138.08977318d0,        22274828.2087116d0,...
-91862664.8659172d0,        367095297.396072d0,       -1442200657.27185d0,...
 5631144196.61182d0,       -4710348628.21890d0,        1021346038.42036d0,...
-1117016053.27279d0,        59972460.8587112d0,        75288870.0720284d0,...
-212806928.468241d0,       -115405344.382576d0,        356500883.607295d0,...
-126091106.569449d0,        38815620.7777347d0,        15369855.1270577d0,...
 10317144.4884869d0,       -4770899.62245940d0,       -10323530.7818197d0,...
-11039796.2069336d0,       -8945328.58041922d0,       -6143202.97108202d0,...
-3452109.05198622d0,       -1058555.31538368d0,        696300.682032124d0,...
 1898279.71193125d0,        2561695.17008900d0,        3116509.27249121d0,...
 3292676.68043480d0,        3415571.82862846d0,        3236953.42139724d0,...
 3400542.54387522d0,        2264891.97899451d0,        3232099.13263190d0,...
 1834681.90576863d0,        2109424.78654154d0,        1572492.94749752d0,...
 1443942.02121884d0,        1202897.13104342d0,        1003845.24665188d0,...
 752068.041422350d0,        653082.626427238d0,        714343.258105084d0,...
-601509.644092593d0,        2650561.01999085d0,       -1630023.53346812d0,...
-2269094.34668720d0,        6579488.99383490d0,       -5070247.56363004d0,...
 1152540.46428450d0,        1470737.94450084d0,       -2279781.27120595d0,...
 2671629.98194521d0,       -2834495.27952843d0,        2849713.62284453d0,...
-2761436.39690483d0,        2726326.34244394d0,       -2343080.30138547d0,...
 1306697.86836667d0,        716033.749449790d0,       -9305698.27365851d0,...
 45790664.9520054d0,       -188410947.798630d0,        745568365.081573d0,...
-2924554361.05994d0,        11419383648.5441d0,       -9551913433.59430d0,...
 351936198.886013d0,       -374259992.493766d0,        94492485.9475322d0,...
-430187808.917017d0,        484949937.691656d0,        3159133.28939998d0,...
-106016914.311604d0,        17037869.3446251d0,       -15239201.3269559d0,...
-6155255.89441250d0,       -12835231.6104304d0,       -11938839.6264102d0,...
-10432572.2839678d0,       -8118424.68135420d0,       -5578404.63752398d0,...
-3467459.76098611d0,       -1504439.93185338d0,       -57387.8062289346d0,...
 993850.098518604d0,        1758984.80825541d0,        2279827.35456069d0,...
 2640406.86815359d0,        2827103.88984286d0,        3104652.62483798d0,...
 2279813.78428260d0,        3214428.33673685d0,        2084778.58377375d0,...
 2252416.77893478d0,        1876869.20393646d0,        1639279.47681103d0,...
 1404536.01967887d0,        1312802.68244406d0,        877814.401015507d0,...
 1021286.20175636d0,        510582.343895456d0,        625601.653335938d0,...
 639266.347855041d0,       -789255.204293482d0,        3118717.14205689d0,...
-2178335.63044239d0,       -2486027.04593037d0,        7375723.03005391d0,...
-5512698.64053649d0,        790265.956825873d0,        2148398.14448616d0,...
-3006567.48926212d0,        3406127.66959442d0,       -3599193.25484431d0,...
 3841913.51386342d0,       -3745593.45311445d0,        3273902.59800991d0,...
-3074138.51467130d0,        2240638.00199567d0,        1693109.62166256d0,...
-15754490.6930673d0,        67959196.9762039d0,       -273158961.711472d0,...
 1083130462.13403d0,       -4249320736.26892d0,        16591020445.6176d0,...
-13878054695.6224d0,        52353073.3690491d0,       -93366933.4244678d0,...
 39167342.5570641d0,        137042021.224214d0,       -99305029.1894521d0,...
 13979576.0384352d0,       -40512592.5158150d0,        14450668.8080335d0,...
-10133084.9180829d0,       -9546588.86300660d0,       -6937126.40841972d0,...
-6101588.42374001d0,       -4876598.19668515d0,       -3765295.72384832d0,...
-2626304.78233867d0,       -1547997.91057000d0,       -648747.040497871d0,...
 59243.0770033744d0,        726673.216335980d0,        1090851.73658809d0,...
 1772774.52001272d0,        1303278.93119964d0,        2344076.35914145d0,...
 1620195.15832706d0,        1840838.07247527d0,        1682566.69417687d0,...
 1529377.42083826d0,        1365608.28633015d0,        1213361.21563896d0,...
 1169351.60524644d0,        824163.668897237d0,        820059.272125908d0,...
 666903.089801559d0,        572333.850048844d0,        437248.949599707d0,...
 281047.557635944d0,        686339.338218104d0,       -1161469.65684215d0,...
 3388688.14470402d0,       -2817479.81029160d0,       -1843680.63314253d0,...
 6790968.80263541d0,       -5249682.98803350d0,        483878.702473845d0,...
 2560008.79132023d0,       -3329423.85069432d0,        3602809.52852616d0,...
-3804218.01580452d0,        3643107.56489813d0,       -3374516.82654975d0,...
 3137468.67964111d0,       -2371630.85992122d0,        649758.820945129d0,...
 3430989.12780482d0,       -20051895.5929770d0,        87756198.4549294d0,...
-353909648.229958d0,        1397369903.09937d0,       -5475862234.68738d0,...
 21379565122.8431d0,       -17883637696.3011d0,        111177709.904569d0,...
-139573383.437839d0,       -28899579.4173019d0,        161470395.343852d0,...
-120371979.518573d0,        13675659.4254083d0,        35272095.9617639d0,...
-31455159.4329608d0,        809457.436969983d0,       -871748.502694782d0,...
-4016208.05909328d0,       -3123904.57699460d0,       -2603983.64259029d0,...
-1765117.00483380d0,       -1138542.92098810d0,       -635909.958579917d0,...
-226541.520594629d0,        185581.003924179d0,        628410.854250820d0,...
 393000.297430413d0,        1289684.79092496d0,        715893.909579487d0,...
 1129110.78619054d0,        851507.236394899d0,        1049180.56542417d0,...
 776605.265611920d0,        822287.184909517d0,        736438.260774013d0,...
 666446.002985408d0,        566931.730308437d0,        424725.934509483d0,...
 500999.795093137d0,        306356.413362735d0,        266692.360140551d0,...
 279779.065936257d0,        144298.311961213d0,        512462.893499746d0,...
-1295080.73013306d0,        3321477.28898100d0,       -3010051.21864172d0,...
-1433098.49709240d0,        5940918.00555164d0,       -4446097.74009156d0,...
 136513.370533470d0,        2417560.91825053d0,       -3414771.20506047d0,...
 3871303.83339594d0,       -3379168.44874009d0,        2049929.43124662d0,...
-2519966.61451277d0,        4755941.89708579d0,       -3223008.92475001d0,...
-1128616.32683289d0,        4937628.44251287d0,       -24362902.6025279d0,...
 106670527.587154d0,       -423112907.797501d0,        1664604340.08965d0,...
-6518224229.10162d0,        25445620396.2887d0,       -21284821087.6769d0,...
-75534359.1678858d0,        153481734.167659d0,        40245752.8040906d0,...
-225041295.229617d0,        157130034.129004d0,       -25020971.3017014d0,...
-48493369.7676301d0,        33354174.8761433d0,       -8535126.86831486d0,...
-5109932.79917191d0,       -415385.170526427d0,       -792103.231661923d0,...
-474609.182423305d0,       -557862.359320145d0,       -446136.161407373d0,...
-75606.9007316074d0,       -188507.054053349d0,        438123.051500502d0,...
 220450.595823004d0,        427268.729194905d0,        464786.425652687d0,...
 535469.745724085d0,        413848.495912023d0,        581160.471957477d0,...
 349265.423381535d0,        540478.744974555d0,        355525.659038983d0,...
 363382.761833747d0,        260970.526652057d0,        338982.381792794d0,...
 204856.095762474d0,        178751.439482813d0,        240194.401657729d0,...
 38807.4609035548d0,        268178.658005729d0,       -202617.723390642d0,...
 710292.436498791d0,       -1520097.69396038d0,        3235733.57419031d0,...
-2922472.69767947d0,       -1228819.22583501d0,        5211058.64353157d0,...
-3936393.11293996d0,        217871.033329213d0,        1795415.50890640d0,...
-2537206.20854533d0,        2929779.62053813d0,       -2796633.86386977d0,...
 2501793.93005091d0,       -2607743.03618242d0,        2749048.48576596d0,...
-2742679.23805373d0,        1705022.66590282d0,        6087792.53760898d0,...
-34592358.4562936d0,        124191199.789391d0,       -473721430.583618d0,...
 1882537363.40637d0,       -7376590681.69641d0,        28782111373.1251d0,...
-24075779659.2507d0,        180720074.936779d0,       -288789510.222777d0,...
-12668358.3436491d0,        255448048.971120d0,       -183518424.813608d0,...
 26693321.9722952d0,        52329846.5469598d0,       -41308104.8233508d0,...
 7695376.78179723d0,        3458792.59199562d0,       -1647435.72472963d0,...
-775308.105947845d0,       -776697.226185997d0,       -160950.282161077d0,...
-201188.480333785d0,        256665.519011910d0,        9695.08795675936d0,...
 230536.537119205d0,        183626.715045650d0,        269464.034634648d0,...
 222525.089123845d0,        239286.448298892d0,        299448.730067292d0,...
 151815.218858036d0,        332365.418035087d0,        115203.226388350d0,...
 184295.780305274d0,        213618.761588801d0,        62256.3584101269d0,...
 198103.150756249d0,        34582.9845093890d0,        159604.843995758d0,...
-17585.7432809034d0,        147191.078058015d0,       -74055.8522827516d0,...
 284777.875318971d0,       -89288.0980006785d0,       -841109.139905942d0,...
 2731772.90874242d0,       -2787863.03784744d0,       -929554.453198078d0,...
 4513936.73453116d0,       -3571560.80561086d0,        342218.718000141d0,...
 1616798.51550998d0,       -2159110.57946145d0,        2127101.62883691d0,...
-2094434.11359183d0,        2093077.45123304d0,       -2053958.07468694d0,...
 1880205.21187353d0,       -1235321.32326667d0,       -805327.713490307d0,...
 7525939.67301893d0,       -33064548.8139973d0,        132053040.917473d0,...
-520165927.589211d0,        2044377850.07785d0,       -7998515309.41797d0,...
 31219717805.1379d0,       -26114541043.5502d0,       -146944116.052990d0,...
 259120144.421280d0,        29623267.1732242d0,       -286412815.455731d0,...
 200397944.137899d0,       -31379003.3401344d0,       -57118298.0744172d0,...
 43322592.9133337d0,       -9672739.55473960d0,       -4710251.08983183d0,...
 1010676.48838618d0,        228615.554411863d0,        489769.355464573d0,...
-86632.8720351955d0,        151315.341363148d0,       -32993.9979089906d0,...
 134277.374750642d0,        69254.5618287494d0,        201699.348444858d0,...
 85622.6087288960d0,        201883.232393041d0,        170055.437968396d0,...
 84453.9209888619d0,        221625.980963642d0,        24782.5783976796d0,...
 155660.106701995d0,        170918.611160562d0,       -70567.4565186914d0,...
 212615.024298761d0,        3200.64703392031d0,       -5931.25628867244d0,...
 213663.845910385d0,       -129878.613546551d0,        89747.1820865181d0,...
 21228.7866265909d0,        142222.163580969d0,       -109578.403284814d0,...
-652746.771702127d0,        2355439.54935266d0,       -2422323.68410301d0,...
-1200835.70590952d0,        4622945.11161385d0,       -3584113.81215508d0,...
 570573.595683865d0,        1049662.21916654d0,       -1659385.16358320d0,...
 1740701.64647714d0,       -1649421.32961616d0,        1881454.04379650d0,...
-1985919.91236465d0,        1839804.07627033d0,       -1336302.18377081d0,...
-933706.377742052d0,        7588245.94112325d0,       -33597033.7651625d0,...
 138805665.004837d0,       -547677342.955559d0,        2144874792.80695d0,...
-8386571246.32422d0,        32734709929.6049d0,       -27381847704.7753d0,...
 97007455.6407193d0,       -159809703.405784d0,       -7268235.11023798d0,...
 144324815.213831d0,       -102613516.395946d0,        15485148.9975244d0,...
 28841107.3570078d0,       -22584360.2111423d0,        4700027.76389494d0,...
 2178366.50705461d0,       -686825.300835939d0,       -193718.874630426d0,...
-315294.747906411d0,        44385.7559973517d0,        11263.5433228438d0,...
 75212.6204149502d0,        44395.8745007363d0,        97743.5073367824d0,...
 37054.7882793264d0,        101093.014779370d0,        39054.3545206713d0,...
 61551.3144807514d0,        55034.2853330958d0,        52615.3967913388d0,...
 30112.4663812268d0,        81253.6695906055d0,       -50844.5023699131d0,...
 122838.604100207d0,       -45850.5543777443d0,        62023.2373734687d0,...
-14187.7043447160d0,        49454.1439294442d0,       -9023.10880079233d0,...
-736.299964739510d0,        105723.704200156d0,       -241091.961593884d0,...
 499087.481308661d0,       -958860.283931304d0,        1521849.99912281d0,...
-1203981.90512645d0,       -552023.742446713d0,        2113999.00083935d0,...
-1805336.15636974d0,        449975.914459218d0,        392481.393503546d0,...
-568703.581874741d0,        593622.192927048d0,       -767489.569809240d0,...
 946007.662100233d0,       -835019.786640570d0,        479035.371648043d0,...
-242816.958622575d0,       -520847.042559147d0,        4159105.45847702d0,...
-17820843.8498306d0,        70367306.1808777d0,       -277063951.809021d0,...
 1088320429.13208d0,       -4256587898.58398d0,        16612861907.1719d0,...
-13896079007.1162d0,...
];
torib = tori*pi/180;
fact = zeros(10000,1);
for i = 3:10000
    fact(i) = fact(i-1) + log(i-1);
end

figure; hold on;
set(gcf,'Position', [790 1 1267 1173]); %get(0, 'Screensize')
n = 1000;
rlist = linspace(1e-15,50.0,n);
vlist = zeros(n,1);
for i = 1:n
    vlist(i) = potarar(rlist(i), cktocm,ekelvin,A,alp,bet,C6,C8,C10,D,F);
end
plot(rlist,vlist);
xlim([3,10]);
ylim([-150,50]);
xline(rmin,"LineWidth",3);
yline(-ekelvin*cktocm,"LineWidth",3);
legend(["ArAr","rmin = 3.771","ekelvin = 141.6"]);
title("Atom-atom potential");
xlabel("Distance, $r$ (Angstroms)");
ylabel("Potential energy $V_\textrm{ArAr}$ (cm$^{-1}$)");
saveas(gcf,main+"/VArAr.png");
hold off;

figure; hold on;
set(gcf,'Position', [790 1 1267 1173]); %get(0, 'Screensize')
thetamin = 0; thetamax = pi/2; ntheta = 10;
thetalist = linspace(thetamin,thetamax,ntheta);
for theta = thetalist
    cost = cos(theta);
    vlist = zeros(n,1);
    for i = 1:n
        vlist(i) = V_2d(rlist(i),cost, nr,nt,rori,coef,fact,torib);
    end
    plot(rlist,vlist);
end
xlim([2.5,8]);
ylim([-3.89e4,-3.82e4]);
legend("$\cos\theta="+string(cos(thetalist))+"$","Location","Southeast");
title(sprintf("Atom-ion potential"));
xlabel("Distance, $r$ (Angstroms)");
ylabel("Potential energy $V_\textrm{Ar-Ar$_2$H$^+$}$ (cm$^{-1}$)");
saveas(gcf,main+"/VArAr2H+.png");
hold off;

rmin = 1e-15; rmax = 50.0; n = 1000; %n = 10000 distance interpolation points in paper
rlist = linspace(rmin,rmax,n);
thetamin = 0; thetamax = pi; ntheta = 100; %ntheta = 1000 angle interpolation points in paper
thetalist = linspace(thetamin,thetamax,ntheta);
costlist = cos(thetalist);
potararlist = zeros(1,n);
for i = 1:n
    potararlist(i) = potarar(rlist(i), cktocm,ekelvin,A,alp,bet,C6,C8,C10,D,F);
end
V_2dlist = zeros(n,ntheta);
for i = 1:n
    for j = 1:ntheta
        V_2dlist(i,j) = V_2d(rlist(i),costlist(j), nr,nt,rori,coef,fact,torib);
    end
    if mod(i,floor(n/100)) == 0
        fprintf("%d/%d\n",i,n);
    end
end

tend = toc(tstart);
fprintf("It took %.1f seconds.\n",tend);
save(main+"/interpolation.mat");

function totenergy = VJudit(coordinate, cktocm,ekelvin,A,alp,bet,C6,C8,C10,D,F,nr,nt,rori,coef,fact,torib)
    si = size(coordinate);
    n = si(1);
    totenergy = 0;
    vector1 = zeros(3,1);
    vector1(1) = coordinate(1,1) - coordinate(3,1);
    vector1(2) = coordinate(1,2) - coordinate(3,2);
    vector1(3) = coordinate(1,3) - coordinate(3,3);
    a = sqrt(vector1(1)^2 + vector1(2)^2 + vector1(3)^2);
    for i = 4:n
        r = sqrt((coordinate(2,1)-coordinate(i,1))^2 + (coordinate(2,2)-coordinate(i,2))^2 + (coordinate(2,3)-coordinate(i,3))^2);
        vector2(1) = coordinate(2,1) - coordinate(i,1);
        vector2(2) = coordinate(2,2) - coordinate(i,2);
        vector2(3) = coordinate(2,3) - coordinate(i,3);
        cosang = (vector1(1)*vector2(1) + vector1(2)*vector2(2) + vector1(3)*vector2(3)) / (a*r);
        v = V_2d(r,cosang, nr,nt,rori,coef,fact,torib);
        totenergy = totenergy + v;
    end
    for i = 4:n-1
        for j = i+1:n
            r = sqrt((coordinate(i,1)-coordinate(j,1))^2 + (coordinate(i,2)-coordinate(j,2))^2 + (coordinate(i,3)-coordinate(j,3))^2);
            v = potarar(r, cktocm,ekelvin,A,alp,bet,C6,C8,C10,D,F);
            totenergy = totenergy + v;
        end
    end
    totenergy = totenergy + 38155.94046159532119d0*(n-4);
end

function v = potarar(r, cktocm,ekelvin,A,alp,bet,C6,C8,C10,D,F)
    if (r < D)
        F = exp(-((D/r-1)^2));
    end
    vcor = (-F*ekelvin) * (C6/r^6 + C8/r^8 + C10/r^10);
    vscf = A*exp(-alp*r + bet*r^2);
    v = (vscf+vcor)*cktocm;
end

function vv = V_2d(r,cost, nr,nt,rori,coef,fact,torib)
    theta = acos(cost);
    q1 = zeros(nt,1); q1p = zeros(nt,1);
    for j = 1:nt
        sum = 0;
        sump = 0;
        for k = 1:nt
            l = 2*(k-1);
            xl = 2*l+1;
            pleg1 = polleg(l,torib(j),fact);
            pleg2 = polleg(l,theta,fact);
            pleg2p = pollegp(l,theta,fact);
            sum = sum + 0.5*xl*pleg1*pleg2;
            sump = sump + 0.5*pleg1*pleg2p;
        end
        q1(j) = sum;
        q1p(j) = sump;
    end
    vv = 0;
    vvp = 0;
    vvthetap = 0;
    irt = 0;
    for j = 1:nt
        for i = 1:nr
            irt = irt + 1;
            x = r;
            if (x < rori(6))
                x = rori(6);
            end
            if (x > rori(nr-6))
                x = rori(nr-6);
            end
            vv = vv + coef(irt)*q1(j)*qr(2,3,rori(i),x);
            vvp = vvp + coef(irt)*q1(j)*qrp(2,3,rori(i),x);
            vvthetap = vvthetap + coef(irt)*q1p(j)*qr(2,3,rori(i),x);
        end
    end
    if (r < rori(6))
        a = vvp;
        b = vv - rori(6)*a;
        vv = a*r+b;
    end
    if (r > rori(nr-6))
        vdiss = -38155.94046159532119;
        vv2 = vv - vdiss;
        vv = vv2*(rori(nr-6)/r)^4 + vdiss;
    end
end

function pleg = polleg(nn,theta,fact)
    pleg = 1.0;
    if (nn ~= 0)
        pleg = 0.0;
        s = nn*log(4.0);
        n1 = nn + 1;
        for i = 1:n1
            j = i-1;
            a = fact(j*2+1) + fact((nn-j)*2+1) - 2.0*fact(j+1) - 2.0*fact(nn-j+1) - s;
            a = exp(a);
            teta = theta * (nn-2*j);
            a = a * cos(teta);
            pleg = pleg + a;
        end
    end
end

function plegp = pollegp(nn,theta,fact) 
    plegp = 0.0;
    if (nn ~= 0)
        xn = nn;
        teta = theta;
        cosine = cos(teta);
        cosine2 = cosine^2;
        if (1-cosine2 < 1.0e-12)
            plegp = 0.5*(xn+1.0)*xn;
            if (cosine < 0.0) 
                plegp = plegp * (-1)^(nn+1);
            end
        else
            pn = polleg(nn,teta,fact);
            pnm1 = polleg(nn-1,teta,fact);
            plegp = (cosine*pn-pnm1)*xn/(cosine2-1.0);
        end
    end
end

function qr = qr(nn,m,xk,xm)
    xmax = max(xk,xm);
    xmin = min(xk,xm);
    al = -nn+1;
    be = m+1;
    ga = nn+m+1;
    x = xmin/xmax;
    f = 0;
    p1 = 1;
    p2 = 1;
    p3 = 1;
    p4 = 1;
    for i = 1:nn-1
        p1 = p1*(al+i-1);
        p2 = p2*(be+i-1);
        p3 = p3*(i);
        p4 = p4*(ga+i-1);
        u = x^i;
        f = f + u*p1*p2/(p3*p4);
    end
    f = f + 1;
    g1 = 1;
    for k = 1:nn-1
        g1 = g1*k;
    end
    g2 = 1;
    for l = 1:m
        g2 = g2*l;
    end
    g3 = 1;
    for j = 1:nn+m
        g3 = g3*j;
    end
    b = g1*g2/g3;
    g = (nn^2)*xmax^(-(m+1))*b;
    qr = f*g;
end

function qrp = qrp(nn,m,xk,xm)
    xmax = max(xk,xm);
    xmin = min(xk,xm);
    part1 = qr(nn,m,xk,xm);
    al = -nn+1;
    be = m+1;
    ga = nn+m+1;
    x = xmin/xmax;
    al1 = -nn+2;
    be1 = m+2;
    ga1 = nn+m+2;
    f = 0;
    p1 = 1;
    p2 = 1;
    p3 = 1;
    p4 = 1;
    for i = 1:nn
        p1 = p1*(al1+i-1);
        p2 = p2*(be1+i-1);
        p3 = p3*(i);
        p4 = p4*(ga1+i-1);
        u = x^i;
        f = f + u*p1*p2/(p3*p4);
    end
    f = f + 1;
    g1 = 1;
    for k = 1:nn-1
        g1 = g1*k;
    end
    g2 = 1;
    for l = 1:m
        g2 = g2*l;
    end
    g3 = 1;
    for j = 1:nn+m
        g3 = g3*j;
    end
    b = g1*g2/g3;
    b = nn^2*b;
    if (xm > xk) 
        part1 = -part1*(m+1)/xm;
        part2 = -xk*(al*be)*f/ga/xm^2;
    else
        part1 = 0;
        part2 = (al*be)*f/xk/ga;
    end
    qrp = part1 + part2*b*xmax^(-(m+1));
end